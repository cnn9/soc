import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder, OneHotEncoder, StandardScaler
from sklearn.compose import ColumnTransformer
from sklearn.metrics import confusion_matrix, accuracy_score
import tensorflow as tf
import matplotlib.pyplot as plt

# Load dataset
dataset = pd.read_csv('DL_PRAC/Churn_Modelling.csv')
X = dataset.iloc[:, 3:-1].values
Y = dataset.iloc[:, -1].values

# Encode categorical data
label_encoder = LabelEncoder()
X[:, 2] = label_encoder.fit_transform(X[:, 2])
column_transformer = ColumnTransformer(
    transformers=[('encoder', OneHotEncoder(), [1])], remainder='passthrough'
)
X = np.array(column_transformer.fit_transform(X))

# Split and scale data
X_train, X_test, Y_train, Y_test = train_test_split(X, Y, test_size=0.2, random_state=0)
scaler = StandardScaler()
X_train = scaler.fit_transform(X_train)
X_test = scaler.transform(X_test)

# Define optimizers to compare
optimizers = {
    'SGD': tf.keras.optimizers.SGD(learning_rate=0.01),
    'Adam': tf.keras.optimizers.Adam(learning_rate=0.001),
    'RMSprop': tf.keras.optimizers.RMSprop(learning_rate=0.001),
    'Adagrad': tf.keras.optimizers.Adagrad(learning_rate=0.01)
}

# Store results
results = {}
histories = {}

# Build and train model with different optimizers
for opt_name, optimizer in optimizers.items():
    print(f"\nTraining with {opt_name} optimizer...")
    
    # Build ANN
    ann = tf.keras.models.Sequential([
        tf.keras.layers.Dense(units=6, activation='relu'),
        tf.keras.layers.Dense(units=6, activation='relu'),
        tf.keras.layers.Dense(units=1, activation='sigmoid')
    ])
    
    # Compile and train
    ann.compile(optimizer=optimizer, loss='binary_crossentropy', metrics=['accuracy'])
    history = ann.fit(X_train, Y_train, batch_size=32, epochs=100, verbose=0, validation_split=0.2)
    
    # Evaluate
    Y_pred = ann.predict(X_test)
    Y_pred = (Y_pred > 0.5)
    accuracy = accuracy_score(Y_test, Y_pred)
    conf_matrix = confusion_matrix(Y_test, Y_pred)
    
    results[opt_name] = {
        'accuracy': accuracy,
        'confusion_matrix': conf_matrix
    }
    histories[opt_name] = history.history

# Print results
for opt_name, result in results.items():
    print(f"\n{opt_name} Results:")
    print(f"Accuracy: {result['accuracy']:.4f}")
    print("Confusion Matrix:")
    print(result['confusion_matrix'])

# Plot training comparison
plt.figure(figsize=(12, 6))
for opt_name, history in histories.items():
    plt.plot(history['accuracy'], label=f'{opt_name} Train')
    plt.plot(history['val_accuracy'], linestyle='--', label=f'{opt_name} Val')
plt.title('Optimizer Comparison - Accuracy')
plt.xlabel('Epoch')
plt.ylabel('Accuracy')
plt.legend()
plt.grid(True)
plt.savefig('optimizer_comparison.png')
plt.close()

# Generate HTML output
html_content = """
<!DOCTYPE html>
<html>
<head>
    <title>Neural Network Optimizer Comparison</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 50%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Neural Network Optimizer Comparison</h1>
    
    <h2>Performance Results</h2>
    <table>
        <tr>
            <th>Optimizer</th>
            <th>Accuracy</th>
            <th>TP</th>
            <th>FP</th>
            <th>FN</th>
            <th>TN</th>
        </tr>
"""

for opt_name, result in results.items():
    cm = result['confusion_matrix']
    html_content += f"""
        <tr>
            <td>{opt_name}</td>
            <td>{result['accuracy']:.4f}</td>
            <td>{cm[0][0]}</td>
            <td>{cm[0][1]}</td>
            <td>{cm[1][0]}</td>
            <td>{cm[1][1]}</td>
        </tr>
    """

html_content += """
    </table>
    
    <h2>Training Progress</h2>
    <img src="optimizer_comparison.png" alt="Optimizer Comparison Graph">
    
</body>
</html>
